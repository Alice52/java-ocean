## 服务降级

### 1. Hystrix[deprecate][tomcat thread pool]

1. feature

   - 服务降级
   - 服务熔断
   - 服务监控
   - 服务限流
   - 服务隔离

2. 定义

   - 用于处理分布式系统的`延迟和容错的`开源库, 保证在一个模块出问题下, 不会出现整个服务失败**`[避免连坐(级联故障)]`**, 也不会导致级联故障, 以提高分布式系统的弹性

3. 断路器理念:

   - 是一种开关装置, 当某个服务单元发生故障时, 通过 `断路器的` **故障监控**, 向服务的调用方返回**`一个符合预期的, 可处理的备选响应[FallBack]`**
   - 而不是长时间等待或者抛出调用方无法处理的异常
   - 这样就保证了服务调用方的线程长时间, 不必要的占用, 从而避免故障在分布式系统中蔓延, 乃至产生雪崩

4. concept

   - [请 10s 后再试]服务降级: fallback = 预期可处理的备选响应

     - 程序运行时异常
     - 超时
     - 服务熔断触发
     - 线程池/信号量打满

   - [拒绝提供服务]服务熔断: break

     - 达到最大访问量时, 而拒绝提供服务
     - 之后调用服务降级方法, 返回友好提示
     - flow: **`熔断 --> 降级 --> 恢复链路调用`**

   - [闸机 QPS]服务限流: flowlimit

     - 秒杀等高并发操作, 严禁拥挤, 排队, 1s N 个, 有序进行

5. 当遇到高并发时, 在一个模块下的不同的方法都会变慢: 使用 JMTER 模拟高并发

   - tomcat 的默认工作线程数被打满, 没有多余的线程来缓解压力和处理请求
   - 大部分的资源被拿去处理高并发的请求, 则导致了本来很快的方法也会变慢

   - code

   ```java
   /**
   * the two method will aslo become slow due to high concurrent<br>
   *
   * @author zack <br>
   * @create 2020-04-02 22:30 <br>
   */
   public interface PaymentService {
      /**
         * this service is mock success call.<br>
         *
         * @param id
         * @return String
         */
      String getPaymentInfo(String id);

      /**
         * this service is mock failed call.<br>
         *
         * @param id
         * @return String
         * @throws InterruptedException
         */
      String getPaymentInfoTimeout(String id) throws InterruptedException;
   }
   ```

### 2. Resilience4j[recommend]

### 3. Sentinel[recommend]

---

## 补充

1. 服务雪崩

   - 扇出: 多个微服务之间调用的时候, 假设 A 调用 B, C; B, C 由分别调用其他的微服务
   - 服务雪崩: 如果扇出上某个微服务调用时间过长或者不可用, 则对微服务 A 的调用就会占用越来越多的资源, 从而导致系统崩溃
   - 服务雪崩: 当你发现某个模块的某个实例失败后, 该模块还会接受流量, 这个有问题的模块还调用了其他模块， 发生的级联的故障
