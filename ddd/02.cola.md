- client: 独立(只需要依赖组件)
- domain: 独立
- infrastructure: 实现 domain(可以使用 client)
- app: 实现 client | 依赖 infrastructure->domain
- adapter: 使用 app -> app

![269594562-c8cfcb86-df64-4d33-b26d-2065b2ac411e](https://github.com/fork-repoes/COLA/assets/42330329/b0e6770a-6372-4468-b74c-8d204f6953a5)

![269593571-4fadbbea-80c9-44e8-9344-879b0e9475e7](https://github.com/fork-repoes/COLA/assets/42330329/13468e44-2ed0-4fbd-b1b2-5d19cefd01de)

## COLA 架构: 框架(提升应用质量)

| 层次               | 包名        | 功能                                | extra                  | 必选 |
| :----------------- | :---------- | :---------------------------------- | :--------------------- | :--- |
| Adapter 层(VO/DTO) | openapi     | 封装 http, rpc 接口                 |                        | 否   |
|                    | controller  | 处理 http 请求                      | 浏览器                 | 否   |
|                    | scheduler   | 处理定时任务                        | 定时任务               | 否   |
|                    | consumer    | 处理外部 message                    | 消息                   | 否   |
| App 层(DTO)        | executor    | 处理 request, 包括 command 和 query |                        | 是   |
|                    | service     | 与 domain 交互负责编排任务          |                        | 是   |
| Domain 层(Entity)  | gateway     | 领域网关, 解耦利器                  | 粗略的理解成一种 SPI   | 是   |
|                    | model       | 领域模型                            |                        | 否   |
|                    | ability     | 领域能力, DomainManager             | 领域对外暴露的服务能力 | 否   |
| Infra 层(DO)       | gatewayimpl | 网关实现                            |                        | 是   |
|                    | mapper      | ibatis 数据库映射                   |                        | 否   |
|                    | config      | 配置信息                            |                        | 否   |
| Driven adapter     | db          | 数据库                              |                        | 否   |
|                    | search      | 搜索引擎                            |                        | 否   |
|                    | rpc         | 外部接口                            |                        | 否   |
| Client SDK         | api         | 服务对外透出的 API                  |                        | 是   |
|                    | dto         | 服务对外的 DTO                      |                        | 是   |

## COLA 组件: 框架功能(可复用组件 + 提升研发效率)

| 组件名称                         | 功能                                                | 依赖                |
| :------------------------------- | :-------------------------------------------------- | :------------------ |
| cola-component-catchlog-starter  | 异常处理和日志组件                                  | exception、dto 组件 |
| cola-component-domain-starter    | Spring 托管的领域实体组件                           | 无                  |
| cola-component-dto               | 定义了 DTO 格式, 包括分页                           | 无                  |
| cola-component-exception         | 定义了异常格式, 主要有 BizException 和 SysException |
| cola-component-extension-starter | 扩展点组件                                          | 无                  |
| cola-component-statemachine      | 状态机组件                                          | 无                  |
| cola-component-test-container    | 测试容器组件                                        | 无                  |

## 相关细节

1. 包的划分: 综合考虑功能和领域两个维度包结构定义
   ![image](https://github.com/fork-repoes/COLA/assets/42330329/807e547c-117d-4d72-a287-f9b3f6643161)

   ![image](https://github.com/fork-repoes/COLA/assets/42330329/3b5df4a4-f5e4-4813-a558-85771d4f7fe2)

2. 防腐层: Anti-Corruption

   - ddd 的概念: 应用不要直接依赖外域的信息，要把外域的信息转换成自己领域上下文（Context）的实体再去使用，从而实现本域和外部依赖的解耦
   - 在 COLA 中将数据库等都泛化为外部依赖, 利用依赖倒置(变成了不直接依赖数据库等-依赖数据库的抽象), 统一使用 gateway 来实现业务领域和外部依赖的解耦: Domain 层定义 Gateway + Infrastructure 提供实现

     ![image](https://github.com/fork-repoes/COLA/assets/42330329/94e68d92-d39a-40ba-ae50-0ae41ed323c5)
     ![image](https://github.com/fork-repoes/COLA/assets/42330329/516ea1f6-1443-4510-947c-491143acd81a)

     - pros: 降低了对外域信息依赖的耦合
     - pros: 是通过上下文映射, 确保本领域边界上下文下领域知识的完整性，实现了统一语言

## client - app - adaptor

1. client 定义接口(类似与 openapi 定义|类似于 app 实现的接口)
   ```java
   interface CustomerServiceI {
     listByName();
   }
   ```
2. app 实现接口
   ```java
   @Service
   public class CustomerServiceImpl implements CustomerServiceI {
       @Resource private CustomerListByNameQryExe customerListByNameQryExe;
       @Override
       public MultiResponse<CustomerDTO> listByName(CustomerListByNameQry customerListByNameQry) {
           return customerListByNameQryExe.execute(customerListByNameQry);
       }
   }
   ```
3. adaptor 调用 client 接口提供 controller/openapi 等服务
   ```java
   @RestController
   public class CustomerController {
       @Autowired private CustomerServiceI customerService;
       @GetMapping(value = "/customer")
       public MultiResponse<CustomerDTO> listCustomerByName(@RequestParam(required = false) String name){
           CustomerListByNameQry customerListByNameQry = new CustomerListByNameQry();
           customerListByNameQry.setName(name);
           return customerService.listByName(customerListByNameQry);
       }
   }
   ```
