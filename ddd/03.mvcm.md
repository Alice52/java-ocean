> **Note** > `Manager 层提供原子的服务接口，Service 层负责依据业务逻辑来编排原子接口`
> 实际开发中 Manager 层得使用建议
>
> 1. 复杂业务，service 提供数据给 Manager 层，负责业务编排
>    把事务下沉到 Manager 层，`Manager层不允许相互调用`，不会出现事务嵌套
> 2. 专注于不带业务 sql 语言，也可以在 manager 层进行通用业务的 dao 层封装
> 3. 避免复杂的 join 查询，在 manager 层拆分成简单 SQL
> 4. 对 Service 层通用能力的下沉, 如缓存方案、中间件通用处理
> 5. 对第三方平台封装的层

![image](https://github.com/fork-repoes/COLA/assets/42330329/ec1d5605-6db7-4915-ae11-c28761f360d4)

1. 开放接口层: 进行 网关安全控制、流量控制等
   - 可直接封装 Service 方法暴露成 RPC 接口
   - 通过 Web 封装成 http 接口
2. 终端显示层：前端 js,html,css 渲染
3. Web 层
   - 主要是对访问控制进行转发
   - 各类基本参数校验
   - 异常处理等
4. Service 层：相对具体的业务逻辑服务层 | 与 DAO 交互
5. Manager 层：通用业务处理层
   - 对第三方平台封装的层，预处理返回结果及转化异常信息，适配上层接口
   - 对 Service 层通用能力的下沉, 如缓存方案、中间件通用处理；
   - 对多个 DAO 的组合复用
6. DAO 层：数据访问层，与底层 MySQL、Oracle、Hbase 进行数据交互。

![image](https://github.com/fork-repoes/COLA/assets/42330329/d5276111-8f2c-4823-be1e-1d65927e2c30)

## manager 层使用举例

1. 提供原子的服务接口(供 serverice 进行编排调用): `/GetUser 方法在不同终端具有不同得行为`

   - 在 APP 中展示用户信息的时候，如果用户不存在，那么要自动给用户创建一个用户
   - 同时，要做一个 HTML5 的页面，HTML5 页面要保留之前的逻辑，也就是不需要创建用户
     ![image](https://github.com/fork-repoes/COLA/assets/42330329/351ee065-017e-4d23-8fbb-05618fd5c20d)

   - `添加Manager层以后，Manager 层提供创建用户和获取用户信息的接口，而 Service 层负责将这两个接口组装起来`

2. 减小长事务且避免嵌套事务

   ```java
   // service: 典型没必要得长事务
   @Transactional(rollbackFor = Throwable.class)
   public Result<String> upOrDown(Long departmentId, Long swapId) {
     // query 1
     // query 2
     // do update
     departmentDao.updateById(swapEntity);
     return Result.OK("success");
   }
   ```

   ```java
   // service: 只进行
   @Transactional(rollbackFor = Throwable.class)
   public Result<String> upOrDown(Long departmentId, Long swapId) {
     // query 1
     // query 2

      xxxManager.upOrDown(departmentSort,swapEntity);
     return Result.OK("success");
   }

   // xxxManager
   @Transactional(rollbackFor = Throwable.class)
   public void upOrDown(DepartmentEntity departmentEntity ,DepartmentEntity swapEntity){
     // do update
     departmentDao.updateById(swapEntity);
   }
   ```
