## [接口幂等性](https://github.com/Alice52/java-ocean/issues/201)

1. 定义: 就是任意多次执行所产生的影响均与一次执行的影响相同
2. 场景

   - Feign 的 retry 机制
   - 用户多次点击
   - 重复提交[连续点了 2 次/web 端回退导致的]
   - 有一些操作用户退出了, 又重新点击进来: 放大了时间差

3. 操作本身具有幂等性

   - 带主键的插入,
   - 查询
   - 定量更新
   - 删除操作

4. 操作不具有幂等性的: 参数不同且指定时间内多次提交

   - POST 增量修改[减库存]: 基于现在的数据库数据更新

5. 解决方案

   1. token 机制: 验证码
      - 先删除令牌 + `redisget&del` 是原子性的
   2. _数据库锁: 悲观锁[for update] + 乐观锁[version]_
   3. 数据库唯一性约束: 微服务间可以提供唯一 Id 进行判别[req-id 或者业务 id]
   4. 业务幂等: 状态机幂

   ```sql
   -- 比如订单系统, 其中的扣款操作的幂等性设计:
   -- 可以通过设置 paystatus & orderId 来做幂等性
   -- 如果同一个订单的调用两次扣款操作, 第一次扣款成功之后则 paystatus 修改为 paid, 第二次执行以下 sql 则没有影响

   -- update userAmount set amount = amount - 'value', paystatus = 'paid' where orderId= 'orderid' and paystatus = 'unpay'
   ```

6. practice: 指定时间内同一个人的同样请求的参数出现大于 1 次就会触发幂等

   - local: `<uri, <md5, count>>` count is stored in ConcurrentHashMap
   - redis: setnxex, key-md5, value-uri=token

## reference

1. https://mp.weixin.qq.com/s?__biz=Mzg4NTcyNjczNg==&mid=2247504222&idx=1&sn=d262f63fb60ad138290ddf4119daabdf&poc_token=HIsWk2ijrb3xvVX5qVfquZhd1pyYzWp4kV7620FI
